<!-- Modal Backdrop -->
<div *ngIf="isVisible" class="modal-backdrop" (click)="onBackdropClick($event)">
  
  <!-- Modal Container -->
  <div class="modal-container" (click)="$event.stopPropagation()">
    
    <!-- Modal Header -->
    <div class="modal-header">
      <div class="flex-1">
        <h2 class="text-xl font-semibold text-gray-900">
          <mat-icon class="inline-icon">edit</mat-icon>
          {{ canEdit ? 'Edit' : 'View' }} Time Entry
        </h2>
        <p class="text-sm text-gray-600 mt-1" *ngIf="editedEntry">
          {{ getEntryTypeLabel() }} â€¢ {{ formatDate(editedEntry.date) }}
        </p>
      </div>
      <button (click)="closeModal()" class="close-button">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Warning Banner -->
    <div class="warning-banner" *ngIf="!canEdit && editPermissions.reason">
      <div class="flex items-center space-x-2">
        <mat-icon class="text-yellow-600">warning</mat-icon>
        <span class="text-sm font-medium text-yellow-800">{{ editPermissions.reason }}</span>
      </div>
    </div>

    <!-- Error Message -->
    <div class="error-banner" *ngIf="errorMessage">
      <div class="flex items-center space-x-2">
        <mat-icon class="text-red-600">error</mat-icon>
        <span class="text-sm font-medium text-red-800">{{ errorMessage }}</span>
      </div>
    </div>

    <!-- Modal Content -->
    <div class="modal-content" *ngIf="editedEntry">
      
      <!-- Entry Status and Type -->
      <div class="entry-summary">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center space-x-3">
            <span class="status-badge" [class]="getStatusBadgeClass()">
              {{ editedEntry.status | titlecase }}
            </span>
            <span class="type-badge">
              {{ getEntryTypeLabel() }}
            </span>
          </div>
          <div class="text-right">
            <span class="text-sm text-gray-600">Total Hours:</span>
            <span class="text-lg font-semibold text-gray-900 ml-2">{{ calculateHours() }}h</span>
          </div>
        </div>
      </div>

      <!-- Edit Form -->
      <form class="edit-form" *ngIf="canEdit">
        
        <!-- Date Field -->
        <div class="form-group">
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Date</mat-label>
            <input matInput 
                   type="date"
                   [(ngModel)]="editedEntry.date"
                   name="date"
                   (ngModelChange)="onFieldChange('date', $event)"
                   [max]="getCurrentDateString()">
            <mat-error *ngIf="validationErrors['date']">{{ validationErrors['date'] }}</mat-error>
          </mat-form-field>
        </div>

        <!-- Time Fields (Clock Entry) -->
        <div class="form-row" *ngIf="isClockEntry">
          <div class="form-group">
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Start Time</mat-label>
              <input matInput 
                     type="time"
                     [(ngModel)]="editedEntry.startTime"
                     name="startTime"
                     readonly
                     class="read-only-field">
              <mat-hint>Clock times cannot be edited</mat-hint>
            </mat-form-field>
          </div>
          <div class="form-group">
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>End Time</mat-label>
              <input matInput 
                     type="time"
                     [(ngModel)]="editedEntry.endTime"
                     name="endTime"
                     readonly
                     class="read-only-field">
              <mat-hint>Clock times cannot be edited</mat-hint>
            </mat-form-field>
          </div>
        </div>

        <!-- Manual Hours Field -->
        <div class="form-group" *ngIf="isManualEntry">
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Hours Worked</mat-label>
            <input matInput 
                   type="number"
                   [(ngModel)]="editedEntry.manualHours"
                   name="manualHours"
                   (ngModelChange)="onFieldChange('manualHours', $event)"
                   min="0.25"
                   max="24"
                   step="0.25"
                   placeholder="e.g., 8.5">
            <mat-hint>Enter hours in decimal format (e.g., 8.5 for 8 hours 30 minutes)</mat-hint>
            <mat-error *ngIf="validationErrors['manualHours']">{{ validationErrors['manualHours'] }}</mat-error>
          </mat-form-field>
        </div>

        <!-- Description Field -->
        <div class="form-group">
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Work Description</mat-label>
            <textarea matInput 
                      [(ngModel)]="editedEntry.description"
                      name="description"
                      (ngModelChange)="onFieldChange('description', $event)"
                      rows="4"
                      placeholder="Describe what you worked on..."
                      required>
            </textarea>
            <mat-hint>Provide a clear description of the work performed</mat-hint>
            <mat-error *ngIf="validationErrors['description']">{{ validationErrors['description'] }}</mat-error>
          </mat-form-field>
        </div>

        <!-- Status Warning for Submitted Entries -->
        <div class="status-warning" *ngIf="editedEntry.status === 'submitted'">
          <div class="flex items-start space-x-2">
            <mat-icon class="text-yellow-600 mt-0.5">info</mat-icon>
            <div>
              <p class="text-sm font-medium text-yellow-800">Entry Status Change</p>
              <p class="text-xs text-yellow-700 mt-1">
                Editing this submitted entry will reset its status to "draft" and require re-submission for approval.
              </p>
            </div>
          </div>
        </div>

      </form>

      <!-- Read-Only View -->
      <div class="read-only-view" *ngIf="!canEdit">
        <div class="space-y-4">
          
          <!-- Date -->
          <div class="read-only-field">
            <label class="field-label">Date</label>
            <p class="field-value">{{ formatDate(editedEntry.date) }}</p>
          </div>

          <!-- Time/Hours -->
          <div class="read-only-field" *ngIf="isClockEntry">
            <label class="field-label">Time Period</label>
            <p class="field-value">{{ formatTime(editedEntry.startTime) }} - {{ formatTime(editedEntry.endTime) }}</p>
          </div>

          <div class="read-only-field" *ngIf="isManualEntry">
            <label class="field-label">Hours Worked</label>
            <p class="field-value">{{ editedEntry.manualHours }} hours</p>
          </div>

          <!-- Description -->
          <div class="read-only-field">
            <label class="field-label">Work Description</label>
            <p class="field-value">{{ editedEntry.description || 'No description provided' }}</p>
          </div>

        </div>
      </div>

      <!-- Proof of Work Section -->
      <div class="proof-section" *ngIf="editedEntry.proofOfWork.length > 0">
        <h3 class="section-title">
          <mat-icon class="inline-icon">attachment</mat-icon>
          Attached Proof of Work
        </h3>
        <div class="proof-list">
          <div *ngFor="let proof of editedEntry.proofOfWork" class="proof-item">
            <div class="flex items-center space-x-2">
              <mat-icon class="text-gray-600">{{ proof.type === 'screenshot' ? 'photo_camera' : 'attach_file' }}</mat-icon>
              <span class="font-medium">{{ proof.fileName || 'Screenshot' }}</span>
              <span class="text-sm text-gray-500">{{ proof.timestamp | date:'short' }}</span>
            </div>
          </div>
        </div>
        <p class="proof-note">
          <mat-icon class="inline-icon text-sm">info</mat-icon>
          Proof of work cannot be modified during editing
        </p>
      </div>

      <!-- Edit History -->
      <div class="edit-history" *ngIf="getEditHistory().length > 0">
        <h3 class="section-title">
          <mat-icon class="inline-icon">history</mat-icon>
          Edit History
        </h3>
        <div class="history-list">
          <div *ngFor="let edit of getEditHistory()" class="history-item">
            <div class="flex items-center justify-between">
              <div>
                <span class="font-medium">{{ edit.field | titlecase }}</span>
                changed from 
                <span class="old-value">{{ edit.oldValue || 'empty' }}</span>
                to 
                <span class="new-value">{{ edit.newValue || 'empty' }}</span>
              </div>
              <span class="text-sm text-gray-500">{{ edit.timestamp | date:'short' }}</span>
            </div>
            <p class="text-xs text-gray-600 mt-1" *ngIf="edit.reason">{{ edit.reason }}</p>
          </div>
        </div>
      </div>

    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-2" *ngIf="hasChanges">
          <mat-icon class="text-orange-600">edit</mat-icon>
          <span class="text-sm text-orange-700">You have unsaved changes</span>
        </div>
        <div class="flex space-x-3">
          <button (click)="cancelEdit()" 
                  mat-stroked-button
                  [disabled]="isProcessing">
            Cancel
          </button>
          <button (click)="saveEntry()" 
                  *ngIf="canEdit"
                  mat-raised-button 
                  color="primary"
                  [disabled]="!hasChanges || isProcessing || hasValidationErrors()">
            <mat-icon *ngIf="isProcessing">hourglass_empty</mat-icon>
            <mat-icon *ngIf="!isProcessing">save</mat-icon>
            {{ isProcessing ? 'Saving...' : 'Save Changes' }}
          </button>
        </div>
      </div>
    </div>

  </div>
</div>